# 组件的构建

## 为什么要构建(编译)

在经过一系列迭代之后, 我们满足了大部分需求，且在项目中运行良好。

接下来为了给更多的项目使用，我们需要把这个组件提出来，变成一个单独的 `npm` 包。

> 为什么要提炼成单独的 npm 包？ 
> 
> 不然你为了共享就需要 cv 整个组件库到不同的项目里，这样每次更新都要重新 cv，而且容易出错

那么，我们可以直接把这些 `vue` / `vue jsx` 组件不经过任何编译，就直接发布 `.vue` 文件到 `npm` 上吗?

答案是既可以，也不可以，而且极其不推荐这么做！

为什么? 

首先我们来回答一下，为什么可以

### 为什么“可以”这么做？

从技术角度看，`npm` 并不限制你发布什么类型的文件。你完全可以上传原始的 `.vue` 文件或包含 JSX 的 `.tsx/.jsx` 文件。

那么消费者在安装你了这个包之后，只要项目配置了相应的编译支持，例如通过 `vite` 的 `@vitejs/plugin-vue`, `@vitejs/plugin-vue-jsx` 或者 `webpack` 的 `vue-loader` 去直接加载这些 `.vue` 文件，那么它们是可以被正确解析的。

但是你有没有发现，这样无形中添加了额外的编译步骤，同时也非常依赖项目中的编译器版本？

比如你 `.vue` 文件里面使用了 `vue@3.3+` 版本才加入的 `defineOptions` 编译宏，但是项目中使用的 `vue` 编译器版本是 `3.2`，那么就会直接报错用不了了。

但是预先把 `.vue` 文件编译成 `js` 文件，这个就可以兼容老版本的 `vue` 了，因为 `defineOptions` 的编译结果为：

```js
defineOptions({
  inheritAttrs: false,
  customOptions: {
    /* ... */
  },
  data() {
    return {
      version: '3.3+'
    }
  }
})
```

```js
const __sfc__ = /*@__PURE__*/Object.assign({
  inheritAttrs: false,
  customOptions: {
    /* ... */
  },
  data() {
    return {
      version: '3.3+'
    }
  }
}, {
  __name: 'App',
  setup(__props, { expose: __expose }) {
  __expose();



const __returned__ = {  }
Object.defineProperty(__returned__, '__isScriptSetup', { enumerable: false, value: true })
return __returned__
}

});
```

在低版本中也能兼容。

### 但为什么“也不可以”这么做（强烈不推荐）？

#### 1. **依赖环境不一致**

不同项目使用的打包工具、Babel/Vite 配置、`vue` 版本、`tsconfig` 等配置可能不一样。这会导致组件在某些项目中无法正确加载、解析或渲染。

#### 2. **构建性能差**

每个使用你这个 npm 包的项目都需要对 `.vue` 文件进行编译，增加了构建时间，浪费计算资源。发布前预编译能大大提高下游使用者的效率。

#### 3. **无法 tree-shaking**

源码形式往往不具备良好的 `tree-shaking` 能力，可能导致打包出来的文件变大，最终影响页面加载性能。

#### 4. **类型定义丢失或不准确**

如果你用 TypeScript 开发组件但不编译，使用者可能得不到准确的类型提示。尤其是 `.vue` 文件本身包含 script/template/style，类型推导更加复杂。

#### 5. **发布 npm 包会暴露内部结构**

发布源码等于把你内部的组织结构完全暴露出来。使用者很容易误用“私有”接口或非 API 级别的代码，增加维护负担。

#### 6. **无法在 Node 中直接执行**

有些服务端渲染或测试环境（如 `jest`）并不会处理 `.vue` 文件，这会导致包无法运行或测试失败。

---

### ✅ 正确做法

1. **构建为可发布格式**：在打包组件库时，推荐使用 [Vite](https://vitejs.dev/guide/build.html#library-mode)、[Rollup](https://rollupjs.org/)、[tsup](https://tsup.egoist.dev/) 等工具编译生成：

   * `esm` 和 `cjs` 格式的 JS
   * `.d.ts` 类型定义文件
   * 单独的 `css` 或 `scss` 文件（如果有）

2. **推荐目录结构（例如）：**

   ```
   dist/
     ├── index.esm.js
     ├── index.cjs.js
     ├── index.d.ts
     └── style.css
   ```

3. **配置 package.json 中的入口字段：**

   ```json
   {
     "main": "./dist/index.cjs.js",
     "module": "./dist/index.esm.js",
     "types": "./dist/index.d.ts",
     "style": "./dist/style.css"
   }
   ```

---

### 总结

虽然你**可以**直接发布 `.vue` 或 `.tsx` 文件，但绝大多数社区实践都强烈**不推荐**这么做。标准做法是**提前编译打包**，只发布构建产物和类型定义。这样才能确保你的组件库被广泛、安全、高效地复用。


